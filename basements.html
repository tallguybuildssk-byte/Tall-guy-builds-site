<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Project Portal ‚Äî Tall Guy Builds Inc.</title>
<meta name="robots" content="noindex">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --navy: #1F2A37; --gold: #C8A96A; --gold-light: #D4BC8A;
    --gold-dim: rgba(200,169,106,0.15); --white: #F7F5F0;
    --g100: #E8E4DD; --g200: #D0CCCC; --g400: #8A8A8A; --g600: #555;
    --green: #4CAF50; --green-lt: #E8F5E9; --blue: #3B82F6; --blue-lt: #E3F2FD;
    --orange: #F59E0B; --orange-lt: #FFF8E1; --red: #EF4444;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: 'DM Sans', -apple-system, sans-serif; background: var(--white); color: var(--navy); min-height: 100vh; -webkit-font-smoothing: antialiased; }

  .loading { display: flex; align-items: center; justify-content: center; min-height: 100vh; flex-direction: column; gap: 12px; }
  .spinner { width: 36px; height: 36px; border: 3px solid var(--g100); border-top-color: var(--gold); border-radius: 50%; animation: spin 0.8s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }

  .error-page { display: flex; align-items: center; justify-content: center; min-height: 100vh; flex-direction: column; gap: 16px; padding: 40px; text-align: center; }
  .error-page h2 { font-size: 20px; }
  .error-page p { color: var(--g400); font-size: 14px; max-width: 400px; line-height: 1.6; }
  .error-page a { color: var(--gold); text-decoration: none; font-weight: 600; }

  .header { background: var(--navy); color: #fff; padding: 36px 24px 32px; text-align: center; position: relative; }
  .header::after { content: ''; position: absolute; bottom: -20px; left: 50%; transform: translateX(-50%); width: 40px; height: 40px; background: var(--white); border-radius: 50%; }
  .brand { font-size: 11px; letter-spacing: 3px; text-transform: uppercase; color: var(--gold); font-weight: 700; margin-bottom: 8px; }
  .header h1 { font-size: 24px; font-weight: 700; margin-bottom: 4px; line-height: 1.3; }
  .header .addr { font-size: 14px; opacity: 0.6; }

  .wrap { max-width: 660px; margin: 0 auto; padding: 36px 20px 40px; }
  .card { background: #fff; border-radius: 16px; padding: 24px; margin-bottom: 20px; box-shadow: 0 2px 12px rgba(0,0,0,0.06); border: 1px solid var(--g100); }
  .card h3 { font-size: 16px; margin-bottom: 16px; }

  .prog-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 14px; }
  .prog-head .lbl { font-size: 14px; font-weight: 600; }
  .prog-head .pct { font-size: 32px; font-weight: 700; color: var(--gold); }
  .prog-head .pct.done { color: var(--green); }
  .bar { width: 100%; height: 10px; border-radius: 10px; background: var(--g100); overflow: hidden; }
  .bar-fill { height: 100%; border-radius: 10px; background: linear-gradient(90deg, var(--gold), var(--gold-light)); transition: width 0.8s ease; }
  .bar-fill.done { background: var(--green); }
  .prog-meta { display: flex; justify-content: space-between; align-items: center; margin-top: 16px; font-size: 13px; color: var(--g400); flex-wrap: wrap; gap: 8px; }

  .badge { display: inline-flex; align-items: center; gap: 4px; padding: 3px 10px; border-radius: 20px; font-size: 11px; font-weight: 600; }
  .badge-ns { color: var(--g400); background: var(--g100); }
  .badge-ip { color: var(--blue); background: var(--blue-lt); }
  .badge-oh { color: var(--orange); background: var(--orange-lt); }
  .badge-c { color: var(--green); background: var(--green-lt); }
  .badge-d { color: var(--red); background: #FFEBEE; }

  .next-up { background: var(--gold-dim); border-radius: 12px; padding: 16px 20px; margin-bottom: 20px; border: 1.5px solid var(--gold); }
  .next-up .nu-lbl { font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: var(--gold); font-weight: 700; margin-bottom: 4px; }
  .next-up .nu-name { font-size: 16px; font-weight: 600; }
  .next-up .nu-date { font-size: 13px; color: var(--g400); margin-top: 2px; }

  .ms { display: flex; gap: 14px; align-items: flex-start; }
  .ms-track { display: flex; flex-direction: column; align-items: center; flex-shrink: 0; }
  .ms-dot { width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 13px; font-weight: 700; color: #fff; }
  .ms-dot.done { background: var(--green); }
  .ms-dot.active { background: var(--gold); }
  .ms-dot.pending { background: var(--g100); color: var(--g400); }
  .ms-line { width: 2px; height: 32px; }
  .ms-line.done { background: var(--green); }
  .ms-line.pending { background: var(--g100); }
  .ms-body { padding-bottom: 18px; }
  .ms-name { font-size: 14px; font-weight: 600; }
  .ms-name.done { color: var(--green); }
  .ms-date { font-size: 12px; color: var(--g400); margin-top: 2px; display: flex; align-items: center; gap: 6px; }

  .upd { padding: 18px 0; border-bottom: 1px solid var(--g100); }
  .upd:last-child { border-bottom: none; padding-bottom: 0; }
  .upd-date { font-size: 12px; font-weight: 600; color: var(--gold); margin-bottom: 6px; }
  .upd-msg { font-size: 14px; line-height: 1.7; }
  .upd-photos { display: flex; gap: 8px; margin-top: 12px; flex-wrap: wrap; }
  .upd-photo { width: 140px; height: 105px; border-radius: 8px; object-fit: cover; border: 1px solid var(--g200); cursor: pointer; transition: transform 0.2s; }
  .upd-photo:hover { transform: scale(1.03); }
  .no-updates { color: var(--g400); font-size: 14px; }

  .lightbox { position: fixed; inset: 0; z-index: 1000; background: rgba(0,0,0,0.92); display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
  .lightbox.on { opacity: 1; pointer-events: all; }
  .lightbox img { max-width: 92%; max-height: 88vh; object-fit: contain; border-radius: 8px; }
  .lb-close { position: absolute; top: 16px; right: 20px; background: none; border: none; color: #fff; font-size: 28px; cursor: pointer; }
  .lb-nav { position: absolute; background: rgba(255,255,255,0.12); border: none; color: #fff; font-size: 24px; cursor: pointer; border-radius: 8px; padding: 14px 18px; }
  .lb-nav:hover { background: rgba(255,255,255,0.2); }
  .lb-prev { left: 16px; }
  .lb-next { right: 16px; }
  .lb-count { position: absolute; bottom: 20px; color: rgba(255,255,255,0.5); font-size: 13px; }

  .footer { text-align: center; padding: 24px 0 20px; font-size: 12px; color: var(--g400); border-top: 1px solid var(--g100); margin-top: 12px; }
  .footer a { color: var(--gold); text-decoration: none; }

  @keyframes fadeUp { from { opacity: 0; transform: translateY(16px); } to { opacity: 1; transform: translateY(0); } }
  .anim { animation: fadeUp 0.5s ease forwards; opacity: 0; }
  .d1 { animation-delay: 0.1s; } .d2 { animation-delay: 0.2s; } .d3 { animation-delay: 0.3s; } .d4 { animation-delay: 0.4s; }

  @media (max-width: 480px) {
    .header h1 { font-size: 20px; }
    .prog-head .pct { font-size: 26px; }
    .wrap { padding: 28px 16px; }
    .card { padding: 18px; }
    .upd-photo { width: 100px; height: 75px; }
  }
</style>
</head>
<body>

<div id="loading" class="loading">
  <div class="spinner"></div>
  <div style="font-size: 14px; color: var(--g400);">Loading your project...</div>
</div>

<div id="error" class="error-page" style="display:none;">
  <div style="font-size: 48px;">üèóÔ∏è</div>
  <h2>Project Not Found</h2>
  <p>This project link may have expired or is invalid. Please contact Tall Guy Builds for an updated link.</p>
  <a href="https://tallguybuilds.ca">‚Üê tallguybuilds.ca</a>
</div>

<div id="app" style="display:none;">
  <div class="header">
    <div class="brand">Tall Guy Builds Inc.</div>
    <h1 id="p-name"></h1>
    <div class="addr" id="p-addr"></div>
  </div>
  <div class="wrap">
    <div class="card anim d1" id="progress-card"></div>
    <div class="next-up anim d2" id="next-up" style="display:none;"></div>
    <div class="card anim d3" id="milestones-card"><h3>Project Milestones</h3><div id="ms-list"></div></div>
    <div class="card anim d4" id="updates-card"><h3>Updates from Your Builder</h3><div id="up-list"></div></div>
    <div class="footer">
      Tall Guy Builds Inc. ¬∑ Built Right. Designed to Last. ¬∑ Regina, SK<br>
      <a href="https://tallguybuilds.ca">tallguybuilds.ca</a>
    </div>
  </div>
</div>

<div class="lightbox" id="lightbox">
  <button class="lb-close" onclick="closeLB()">‚úï</button>
  <button class="lb-nav lb-prev" onclick="navLB(-1)">‚Äπ</button>
  <button class="lb-nav lb-next" onclick="navLB(1)">‚Ä∫</button>
  <img id="lb-img" src="" alt="">
  <div class="lb-count" id="lb-count"></div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<script src="../shared/firebase-config.js"></script>
<script>
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ
  function fmt(d) {
    if (!d) return '';
    return new Date(d + 'T12:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
  }
  function badge(s) {
    const m = { 'Not Started':'badge-ns', 'In Progress':'badge-ip', 'On Hold':'badge-oh', 'Completed':'badge-c', 'Delayed':'badge-d' };
    const i = { 'Not Started':'‚óã', 'In Progress':'‚óê', 'On Hold':'‚è∏', 'Completed':'‚óè', 'Delayed':'‚ö†' };
    return `<span class="badge ${m[s]||'badge-ns'}">${i[s]||'‚óã'} ${s}</span>`;
  }

  // ‚îÄ‚îÄ Lightbox ‚îÄ‚îÄ
  let lbPhotos=[], lbIdx=0;
  function openLB(photos,i){ lbPhotos=photos; lbIdx=i||0; updLB(); document.getElementById('lightbox').classList.add('on'); }
  function closeLB(){ document.getElementById('lightbox').classList.remove('on'); }
  function navLB(d){ lbIdx=(lbIdx+d+lbPhotos.length)%lbPhotos.length; updLB(); }
  function updLB(){
    document.getElementById('lb-img').src=lbPhotos[lbIdx];
    document.getElementById('lb-count').textContent=lbPhotos.length>1?`${lbIdx+1} / ${lbPhotos.length}`:'';
    document.querySelector('.lb-prev').style.display=lbPhotos.length>1?'':'none';
    document.querySelector('.lb-next').style.display=lbPhotos.length>1?'':'none';
  }
  document.getElementById('lightbox').addEventListener('click',function(e){if(e.target===this)closeLB()});
  document.addEventListener('keydown',function(e){if(!document.getElementById('lightbox').classList.contains('on'))return;if(e.key==='Escape')closeLB();if(e.key==='ArrowLeft')navLB(-1);if(e.key==='ArrowRight')navLB(1);});

  // ‚îÄ‚îÄ Render ‚îÄ‚îÄ
  function render(project, milestones, updates) {
    document.getElementById('p-name').textContent = project.name;
    document.getElementById('p-addr').textContent = project.address;
    document.title = project.name + ' ‚Äî Tall Guy Builds';

    const total = milestones.length;
    const done = milestones.filter(m => m.status === 'Completed').length;
    const pct = total > 0 ? Math.round((done / total) * 100) : 0;
    const isDone = pct === 100;

    document.getElementById('progress-card').innerHTML = `
      <div class="prog-head">
        <span class="lbl">Overall Progress</span>
        <span class="pct ${isDone?'done':''}">${pct}%</span>
      </div>
      <div class="bar"><div class="bar-fill ${isDone?'done':''}" style="width:${pct}%"></div></div>
      <div class="prog-meta">
        <span>Started ${fmt(project.startDate)}</span>
        ${badge(project.status)}
        <span>${project.endDate ? 'Est. completion '+fmt(project.endDate) : ''}</span>
      </div>
    `;

    const nextMs = milestones.find(m => m.status !== 'Completed');
    if (nextMs) {
      const nu = document.getElementById('next-up');
      nu.style.display = '';
      nu.innerHTML = `
        <div class="nu-lbl">Up Next</div>
        <div class="nu-name">${nextMs.name}</div>
        <div class="nu-date">Target: ${fmt(nextMs.date)}</div>
      `;
    }

    document.getElementById('ms-list').innerHTML = milestones.map((m, i) => {
      const d = m.status === 'Completed';
      const a = m.status === 'In Progress';
      const cls = d?'done':a?'active':'pending';
      const last = i === milestones.length - 1;
      return `<div class="ms">
        <div class="ms-track">
          <div class="ms-dot ${cls}">${d?'‚úì':i+1}</div>
          ${!last?`<div class="ms-line ${d?'done':'pending'}"></div>`:''}
        </div>
        <div class="ms-body">
          <div class="ms-name ${d?'done':''}">${m.name}</div>
          <div class="ms-date">${fmt(m.date)} ¬∑ ${badge(m.status)}</div>
        </div>
      </div>`;
    }).join('');

    if (updates.length === 0) {
      document.getElementById('up-list').innerHTML = '<p class="no-updates">No updates yet. Check back soon!</p>';
    } else {
      document.getElementById('up-list').innerHTML = updates.map(u => {
        let photos = '';
        if (u.photos && u.photos.length > 0) {
          const photosJson = JSON.stringify(u.photos).replace(/"/g, '&quot;');
          photos = `<div class="upd-photos">${u.photos.map((p,i) =>
            `<img class="upd-photo" src="${p}" alt="Progress photo" onclick="openLB(${photosJson},${i})">`
          ).join('')}</div>`;
        }
        return `<div class="upd">
          <div class="upd-date">${fmt(u.date)}</div>
          <div class="upd-msg">${u.message}</div>
          ${photos}
        </div>`;
      }).join('');
    }

    document.getElementById('loading').style.display = 'none';
    document.getElementById('app').style.display = '';
  }

  // ‚îÄ‚îÄ Load from Firebase ‚îÄ‚îÄ
  async function loadProject(token) {
    try {
      const snap = await db.collection('projects')
        .where('shareToken', '==', token).limit(1).get();

      if (snap.empty) {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('error').style.display = '';
        return;
      }

      const doc = snap.docs[0];
      const project = doc.data();

      const msSnap = await doc.ref.collection('milestones').orderBy('order').get();
      const milestones = msSnap.docs.map(d => d.data());

      const upSnap = await doc.ref.collection('updates').orderBy('date', 'desc').get();
      const updates = upSnap.docs.map(d => d.data());

      render(project, milestones, updates);
    } catch (err) {
      console.error('Error loading project:', err);
      document.getElementById('loading').style.display = 'none';
      document.getElementById('error').style.display = '';
    }
  }

  // ‚îÄ‚îÄ Init ‚îÄ‚îÄ
  const params = new URLSearchParams(window.location.search);
  const token = params.get('id');
  if (!token) {
    document.getElementById('loading').style.display = 'none';
    document.getElementById('error').style.display = '';
  } else {
    loadProject(token);
  }
</script>
</body>
</html>
