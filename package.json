// Tall Guy Builds - Project Manager
// Real Firebase Auth + Firestore. Firebase loaded via CDN in index.html.
const { useState, useEffect } = React;

const firebaseConfig = {
  apiKey: "AIzaSyC1rQb5" + "HlonfZYfdhVVW-ae44jU" + "LMCaW1w",
  authDomain: "tallguybuilds-cce06.firebaseapp.com",
  projectId: "tallguybuilds-cce06",
  storageBucket: "tallguybuilds-cce06.firebasestorage.app",
  messagingSenderId: "70871321733",
  appId: "1:70871321733:web:f2698699cfec6abc1eedec"
};
if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const OWNER_EMAIL = "tallguybuildssk@gmail.com";

const C = {
  navy:"#1A2332",navyLight:"#243044",navyDark:"#111B27",
  gold:"#D4A853",goldDim:"#A8884A",muted:"#7B8A9B",border:"#263345",
  success:"#34C778",warn:"#F59E0B",danger:"#EF4444",white:"#FFFFFF",accent:"#4A9EFF"
};
const font = "'DM Serif Display', serif";
const fontBody = "'DM Sans', sans-serif";
const S = {
  page:{minHeight:"100vh",background:C.navy,fontFamily:fontBody,color:C.white},
  card:{background:C.navyLight,border:"1px solid "+C.border,borderRadius:12,padding:24},
  input:{width:"100%",padding:"10px 14px",borderRadius:8,border:"1px solid "+C.border,background:C.navyDark,color:C.white,fontFamily:fontBody,fontSize:15,outline:"none",boxSizing:"border-box"},
  btn:{width:"100%",padding:"12px",borderRadius:8,border:"none",background:C.gold,color:C.navyDark,fontFamily:fontBody,fontWeight:700,fontSize:16,cursor:"pointer"},
  btnSec:{background:"transparent",border:"1px solid "+C.border,color:C.muted,padding:"10px",borderRadius:8,fontFamily:fontBody,fontSize:14,cursor:"pointer",width:"100%"},
  label:{display:"block",fontSize:12,fontWeight:600,color:C.muted,marginBottom:6,textTransform:"uppercase",letterSpacing:1}
};

function friendlyError(code) {
  const m = {
    "auth/user-not-found":"No account found with that email.",
    "auth/wrong-password":"Incorrect password.",
    "auth/invalid-email":"Please enter a valid email address.",
    "auth/email-already-in-use":"An account already exists with that email.",
    "auth/weak-password":"Password must be at least 6 characters.",
    "auth/too-many-requests":"Too many attempts. Please wait a moment.",
    "auth/invalid-credential":"Incorrect email or password."
  };
  return m[code] || "Something went wrong. Please try again.";
}

function LoadingScreen() {
  return (
    <div style={{...S.page,display:"flex",alignItems:"center",justifyContent:"center"}}>
      <div style={{fontFamily:font,fontSize:20,color:C.muted}}>Loading...</div>
    </div>
  );
}

function AuthScreen() {
  const [mode, setMode] = useState("login");
  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");
  const [confirm, setConfirm] = useState("");
  const [error, setError] = useState("");
  const [loading, setLoading] = useState(false);
  const [resetSent, setResetSent] = useState(false);

  async function handleLogin(e) {
    e.preventDefault(); setError(""); setLoading(true);
    try { await auth.signInWithEmailAndPassword(email.trim(), password); }
    catch(err) { setError(friendlyError(err.code)); }
    setLoading(false);
  }

  async function handleSignup(e) {
    e.preventDefault(); setError("");
    if (password !== confirm) { setError("Passwords do not match."); return; }
    if (password.length < 6) { setError("Password must be at least 6 characters."); return; }
    setLoading(true);
    try {
      const cred = await auth.createUserWithEmailAndPassword(email.trim(), password);
      await db.collection("users").doc(cred.user.uid).set({
        email: email.trim().toLowerCase(), role:"client",
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
    } catch(err) { setError(friendlyError(err.code)); }
    setLoading(false);
  }

  async function handleReset() {
    setError("");
    if (!email.trim()) { setError("Enter your email above first."); return; }
    try { await auth.sendPasswordResetEmail(email.trim()); setResetSent(true); }
    catch(err) { setError(friendlyError(err.code)); }
  }

  return (
    <div style={{...S.page,display:"flex",alignItems:"center",justifyContent:"center",padding:16}}>
      <div style={{width:"100%",maxWidth:400}}>
        <div style={{textAlign:"center",marginBottom:32}}>
          <img src="../img-002.webp" alt="TGB" style={{width:80,height:80,borderRadius:12,marginBottom:12}} />
          <div style={{fontFamily:font,fontSize:22,color:C.white}}>Tall Guy Builds</div>
          <div style={{fontSize:12,color:C.muted,letterSpacing:2,textTransform:"uppercase",marginTop:4}}>Project Management</div>
        </div>
        <div style={S.card}>
          <h2 style={{fontFamily:font,fontSize:24,margin:"0 0 6px 0"}}>{mode==="login"?"Welcome back":"Create account"}</h2>
          <p style={{fontSize:14,color:C.muted,margin:"0 0 24px 0"}}>{mode==="login"?"Sign in to view your project":"Set up your client account"}</p>
          {error && <div style={{background:"rgba(239,68,68,0.15)",border:"1px solid "+C.danger,borderRadius:8,padding:"10px 14px",marginBottom:16,fontSize:14,color:"#fca5a5"}}>{error}</div>}
          {resetSent && <div style={{background:"rgba(52,199,120,0.15)",border:"1px solid "+C.success,borderRadius:8,padding:"10px 14px",marginBottom:16,fontSize:14,color:"#6ee7b7"}}>Password reset email sent! Check your inbox.</div>}
          <form onSubmit={mode==="login"?handleLogin:handleSignup}>
            <div style={{marginBottom:16}}>
              <label style={S.label}>Email</label>
              <input style={S.input} type="email" value={email} onChange={e=>setEmail(e.target.value)} placeholder="you@example.com" required autoComplete="email" />
            </div>
            <div style={{marginBottom:mode==="signup"?16:8}}>
              <label style={S.label}>Password</label>
              <input style={S.input} type="password" value={password} onChange={e=>setPassword(e.target.value)} placeholder={mode==="signup"?"At least 6 characters":"Your password"} required autoComplete={mode==="login"?"current-password":"new-password"} />
            </div>
            {mode==="signup" && (
              <div style={{marginBottom:16}}>
                <label style={S.label}>Confirm Password</label>
                <input style={S.input} type="password" value={confirm} onChange={e=>setConfirm(e.target.value)} placeholder="Repeat your password" required autoComplete="new-password" />
              </div>
            )}
            {mode==="login" && (
              <div style={{textAlign:"right",marginBottom:20}}>
                <button type="button" onClick={handleReset} style={{background:"none",border:"none",color:C.goldDim,fontSize:13,cursor:"pointer",padding:0}}>Forgot password?</button>
              </div>
            )}
            <button type="submit" style={S.btn} disabled={loading}>{loading?"Please wait...":(mode==="login"?"Sign In":"Create Account")}</button>
          </form>
          <div style={{marginTop:16,textAlign:"center",fontSize:14,color:C.muted}}>
            {mode==="login"?(<>New client?{" "}<button onClick={()=>{setMode("signup");setError("");}} style={{background:"none",border:"none",color:C.gold,cursor:"pointer",fontSize:14,padding:0}}>Create an account</button></>)
            :(<>Already have an account?{" "}<button onClick={()=>{setMode("login");setError("");}} style={{background:"none",border:"none",color:C.gold,cursor:"pointer",fontSize:14,padding:0}}>Sign in</button></>)}
          </div>
        </div>
      </div>
    </div>
  );
}

function ClientPortal({ user, onSignOut }) {
  const [projects, setProjects] = useState([]);
  const [loading, setLoading] = useState(true);
  const [selected, setSelected] = useState(null);

  useEffect(() => {
    const unsub = db.collection("jobs").where("clientEmail","==",user.email.toLowerCase())
      .onSnapshot(snap => {
        const data = snap.docs.map(d=>({id:d.id,...d.data()}));
        setProjects(data);
        if (data.length > 0 && !selected) setSelected(data[0].id);
        setLoading(false);
      }, ()=>setLoading(false));
    return ()=>unsub();
  }, [user.email]);

  const job = projects.find(p=>p.id===selected);
  const sc = s => s==="In Progress"?C.accent:s==="Completed"?C.success:C.warn;

  return (
    <div style={S.page}>
      <div style={{background:C.navyDark,borderBottom:"1px solid "+C.border,padding:"14px 20px",display:"flex",alignItems:"center",justifyContent:"space-between"}}>
        <div style={{display:"flex",alignItems:"center",gap:10}}>
          <img src="../img-002.webp" alt="TGB" style={{width:36,height:36,borderRadius:6}} />
          <div>
            <div style={{fontFamily:font,fontSize:16}}>Tall Guy Builds</div>
            <div style={{fontSize:11,color:C.muted,letterSpacing:1}}>CLIENT PORTAL</div>
          </div>
        </div>
        <button onClick={onSignOut} style={{...S.btnSec,width:"auto",padding:"6px 14px",fontSize:13}}>Sign Out</button>
      </div>
      <div style={{padding:20,maxWidth:800,margin:"0 auto"}}>
        {loading && <div style={{color:C.muted,textAlign:"center",padding:40}}>Loading your projects...</div>}
        {!loading && projects.length===0 && (
          <div style={{...S.card,textAlign:"center",padding:40,marginTop:20}}>
            <div style={{fontSize:40,marginBottom:16}}>üèóÔ∏è</div>
            <div style={{fontFamily:font,fontSize:20,marginBottom:8}}>No projects yet</div>
            <div style={{color:C.muted,fontSize:14}}>Your projects will appear here once your builder sets them up.<br/>Questions? Call or text: <strong style={{color:C.gold}}>(306) 737-5407</strong></div>
          </div>
        )}
        {!loading && projects.length > 1 && (
          <div style={{marginBottom:16,display:"flex",gap:8,flexWrap:"wrap"}}>
            {projects.map(p=>(
              <button key={p.id} onClick={()=>setSelected(p.id)}
                style={{padding:"8px 16px",borderRadius:8,border:"1px solid "+(selected===p.id?C.gold:C.border),background:selected===p.id?"rgba(212,168,83,0.15)":"transparent",color:selected===p.id?C.gold:C.muted,cursor:"pointer",fontFamily:fontBody,fontSize:14}}>
                {p.name||p.title||"Project"}
              </button>
            ))}
          </div>
        )}
        {job && (
          <div>
            <div style={{...S.card,marginBottom:16}}>
              <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start",flexWrap:"wrap",gap:8}}>
                <div>
                  <div style={{fontSize:12,color:C.gold,fontWeight:700,letterSpacing:1,textTransform:"uppercase",marginBottom:4}}>{job.type||"Project"}</div>
                  <h1 style={{fontFamily:font,fontSize:24,margin:"0 0 4px 0"}}>{job.name||job.title}</h1>
                  <div style={{fontSize:14,color:C.muted}}>{job.clientName} ¬∑ {job.startDate} ‚Äî {job.endDate}</div>
                </div>
                <div style={{padding:"6px 14px",borderRadius:20,border:"1px solid "+sc(job.status),color:sc(job.status),fontSize:13,fontWeight:600}}>{job.status||"In Progress"}</div>
              </div>
              {job.progress!==undefined && (
                <div style={{marginTop:16}}>
                  <div style={{display:"flex",justifyContent:"space-between",fontSize:12,color:C.muted,marginBottom:6}}><span>Progress</span><span>{job.progress}%</span></div>
                  <div style={{height:6,background:C.border,borderRadius:3}}>
                    <div style={{height:"100%",width:job.progress+"%",background:C.gold,borderRadius:3,transition:"width 0.4s"}} />
                  </div>
                </div>
              )}
              {job.value && <div style={{marginTop:12,fontSize:13,color:C.muted}}>Contract value: <strong style={{color:C.gold}}>${Number(job.value).toLocaleString()}</strong></div>}
            </div>
            {job.milestones&&job.milestones.length>0&&(
              <div style={{...S.card,marginBottom:16}}>
                <h3 style={{fontFamily:font,fontSize:18,margin:"0 0 16px 0"}}>Project Milestones</h3>
                <div style={{display:"flex",flexDirection:"column",gap:10}}>
                  {job.milestones.map((m,i)=>(
                    <div key={i} style={{display:"flex",alignItems:"center",gap:12}}>
                      <div style={{width:20,height:20,borderRadius:"50%",flexShrink:0,background:m.done?C.success:C.border,border:"2px solid "+(m.done?C.success:C.border),display:"flex",alignItems:"center",justifyContent:"center"}}>
                        {m.done&&<span style={{fontSize:11,color:C.navyDark}}>‚úì</span>}
                      </div>
                      <div><div style={{fontSize:14,color:m.done?C.muted:C.white,textDecoration:m.done?"line-through":"none"}}>{m.label}</div>{m.date&&<div style={{fontSize:12,color:C.muted}}>{m.date}</div>}</div>
                    </div>
                  ))}
                </div>
              </div>
            )}
            {job.updates&&job.updates.length>0&&(
              <div style={S.card}>
                <h3 style={{fontFamily:font,fontSize:18,margin:"0 0 16px 0"}}>Updates from Your Builder</h3>
                <div style={{display:"flex",flexDirection:"column",gap:12}}>
                  {[...job.updates].reverse().map((u,i)=>(
                    <div key={i} style={{borderLeft:"3px solid "+C.gold,paddingLeft:14}}>
                      <div style={{fontSize:12,color:C.muted,marginBottom:4}}>{u.date}</div>
                      <div style={{fontSize:14}}>{u.text}</div>
                    </div>
                  ))}
                </div>
              </div>
            )}
          </div>
        )}
      </div>
    </div>
  );
}

function JobCard({ job }) {
  const sc = s => s==="In Progress"?C.accent:s==="Completed"?C.success:C.warn;
  return (
    <div style={{...S.card,marginBottom:12}}>
      <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start",flexWrap:"wrap",gap:8}}>
        <div>
          <div style={{fontSize:11,color:C.gold,fontWeight:700,letterSpacing:1,textTransform:"uppercase",marginBottom:4}}>{job.type||"Project"}</div>
          <div style={{fontFamily:font,fontSize:20,marginBottom:4}}>{job.name||job.title}</div>
          <div style={{fontSize:13,color:C.muted}}>{job.clientName} ¬∑ {job.startDate} ‚Äî {job.endDate}</div>
        </div>
        <div style={{display:"flex",flexDirection:"column",alignItems:"flex-end",gap:6}}>
          <div style={{padding:"4px 12px",borderRadius:20,border:"1px solid "+sc(job.status),color:sc(job.status),fontSize:12,fontWeight:600}}>{job.status||"Not Started"}</div>
          {job.value&&<div style={{fontSize:13,color:C.gold}}>${Number(job.value).toLocaleString()}</div>}
        </div>
      </div>
      {job.progress!==undefined&&(
        <div style={{marginTop:12}}>
          <div style={{height:4,background:C.border,borderRadius:2}}>
            <div style={{height:"100%",width:(job.progress||0)+"%",background:C.gold,borderRadius:2}} />
          </div>
          <div style={{fontSize:11,color:C.muted,marginTop:4}}>{job.progress||0}% complete ¬∑ {(job.milestones||[]).length} milestones ¬∑ {(job.updates||[]).length} updates</div>
        </div>
      )}
    </div>
  );
}

function NewJobModal({ onClose }) {
  const [form, setForm] = useState({name:"",type:"Basement",clientName:"",clientEmail:"",startDate:"",endDate:"",value:"",status:"Not Started",progress:0});
  const [saving, setSaving] = useState(false);
  const [error, setError] = useState("");
  const set = (k,v) => setForm(f=>({...f,[k]:v}));

  async function save(e) {
    e.preventDefault(); setError("");
    if (!form.name.trim()||!form.clientEmail.trim()) { setError("Project name and client email are required."); return; }
    setSaving(true);
    try {
      await db.collection("jobs").add({...form,clientEmail:form.clientEmail.trim().toLowerCase(),progress:Number(form.progress),value:Number(form.value)||0,milestones:[],updates:[],createdAt:firebase.firestore.FieldValue.serverTimestamp()});
      onClose();
    } catch(err) { setError("Failed to save. Please try again."); }
    setSaving(false);
  }

  const inp = {...S.input,marginBottom:0};
  const row = (lbl,el) => (<div style={{marginBottom:14}}><label style={S.label}>{lbl}</label>{el}</div>);

  return (
    <div style={{position:"fixed",inset:0,background:"rgba(0,0,0,0.7)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1000,padding:16}}>
      <div style={{...S.card,width:"100%",maxWidth:500,maxHeight:"90vh",overflow:"auto"}}>
        <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:20}}>
          <h2 style={{fontFamily:font,fontSize:22,margin:0}}>New Project</h2>
          <button onClick={onClose} style={{background:"none",border:"none",color:C.muted,fontSize:20,cursor:"pointer"}}>‚úï</button>
        </div>
        {error&&<div style={{background:"rgba(239,68,68,0.15)",border:"1px solid "+C.danger,borderRadius:8,padding:"10px 14px",marginBottom:16,fontSize:14,color:"#fca5a5"}}>{error}</div>}
        <form onSubmit={save}>
          {row("Project Name",<input style={inp} value={form.name} onChange={e=>set("name",e.target.value)} placeholder="e.g. Smith Basement Development" required />)}
          {row("Type",<select style={inp} value={form.type} onChange={e=>set("type",e.target.value)}>{["Basement","Kitchen","Bathroom","Deck","Garage","Renovation","Other"].map(t=><option key={t}>{t}</option>)}</select>)}
          {row("Client Name",<input style={inp} value={form.clientName} onChange={e=>set("clientName",e.target.value)} placeholder="e.g. John & Jane Smith" />)}
          {row("Client Email",<input style={inp} type="email" value={form.clientEmail} onChange={e=>set("clientEmail",e.target.value)} placeholder="client@email.com" required />)}
          <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:12,marginBottom:14}}>
            <div>{row("Start Date",<input style={inp} type="date" value={form.startDate} onChange={e=>set("startDate",e.target.value)} />)}</div>
            <div>{row("End Date",<input style={inp} type="date" value={form.endDate} onChange={e=>set("endDate",e.target.value)} />)}</div>
          </div>
          {row("Contract Value ($)",<input style={inp} type="number" value={form.value} onChange={e=>set("value",e.target.value)} placeholder="0" />)}
          {row("Status",<select style={inp} value={form.status} onChange={e=>set("status",e.target.value)}>{["Not Started","In Progress","Completed"].map(s=><option key={s}>{s}</option>)}</select>)}
          {row("Progress ("+form.progress+"%)",<input style={inp} type="range" min={0} max={100} value={form.progress} onChange={e=>set("progress",e.target.value)} />)}
          <button type="submit" style={S.btn} disabled={saving}>{saving?"Saving...":"Save Project"}</button>
        </form>
      </div>
    </div>
  );
}

function OwnerDashboard({ user, onSignOut }) {
  const [page, setPage] = useState("dashboard");
  const [jobs, setJobs] = useState([]);
  const [loading, setLoading] = useState(true);
  const [showNew, setShowNew] = useState(false);

  useEffect(() => {
    const unsub = db.collection("jobs").orderBy("createdAt","desc")
      .onSnapshot(snap=>{setJobs(snap.docs.map(d=>({id:d.id,...d.data()})));setLoading(false);},()=>setLoading(false));
    return ()=>unsub();
  }, []);

  const active=jobs.filter(j=>j.status==="In Progress");
  const upcoming=jobs.filter(j=>j.status==="Not Started");
  const completed=jobs.filter(j=>j.status==="Completed");
  const totalVal=jobs.reduce((s,j)=>s+(Number(j.value)||0),0);

  const clientMap={};
  jobs.forEach(j=>{if(j.clientEmail){if(!clientMap[j.clientEmail])clientMap[j.clientEmail]={name:j.clientName||j.clientEmail,email:j.clientEmail,jobs:[]};clientMap[j.clientEmail].jobs.push(j);}});
  const clients=Object.values(clientMap);

  return (
    <div style={{...S.page,display:"flex",minHeight:"100vh"}}>
      <div style={{width:220,background:C.navyDark,borderRight:"1px solid "+C.border,display:"flex",flexDirection:"column",padding:"20px 0",flexShrink:0}}>
        <div style={{padding:"0 16px 20px 16px",borderBottom:"1px solid "+C.border,marginBottom:20}}>
          <img src="../img-002.webp" alt="TGB" style={{width:44,height:44,borderRadius:8,display:"block",marginBottom:8}} />
          <div style={{fontFamily:font,fontSize:14}}>Tall Guy Builds</div>
          <div style={{fontSize:11,color:C.gold,letterSpacing:1}}>PROJECT MANAGER</div>
        </div>
        {[{id:"dashboard",label:"Dashboard",icon:"üìä"},{id:"jobs",label:"Projects",icon:"üî®"},{id:"clients",label:"Clients",icon:"üë•"}].map(nav=>(
          <button key={nav.id} onClick={()=>setPage(nav.id)} style={{display:"flex",alignItems:"center",gap:10,padding:"10px 16px",background:page===nav.id?"rgba(212,168,83,0.15)":"transparent",borderLeft:page===nav.id?"3px solid "+C.gold:"3px solid transparent",border:"none",color:page===nav.id?C.gold:C.muted,fontSize:14,cursor:"pointer",fontFamily:fontBody,textAlign:"left",width:"100%"}}>
            <span>{nav.icon}</span>{nav.label}
          </button>
        ))}
        <div style={{flex:1}} />
        <div style={{padding:"16px",borderTop:"1px solid "+C.border}}>
          <div style={{fontSize:12,color:C.muted,marginBottom:8,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{user.email}</div>
          <button onClick={onSignOut} style={{...S.btnSec,fontSize:13}}>Sign Out</button>
        </div>
      </div>
      <div style={{flex:1,padding:24,overflow:"auto"}}>
        {loading&&<div style={{color:C.muted}}>Loading...</div>}
        {!loading&&page==="dashboard"&&(
          <div>
            <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:24}}>
              <h1 style={{fontFamily:font,fontSize:28,margin:0}}>Dashboard</h1>
              <button onClick={()=>setShowNew(true)} style={{...S.btn,width:"auto",padding:"10px 20px",fontSize:14}}>+ New Project</button>
            </div>
            <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(140px,1fr))",gap:12,marginBottom:24}}>
              {[{label:"ACTIVE",value:active.length,color:C.accent},{label:"UPCOMING",value:upcoming.length,color:C.warn},{label:"COMPLETED",value:completed.length,color:C.success},{label:"TOTAL VALUE",value:"$"+totalVal.toLocaleString(),color:C.gold}].map(s=>(
                <div key={s.label} style={S.card}><div style={{fontSize:11,color:C.muted,letterSpacing:1,marginBottom:6}}>{s.label}</div><div style={{fontFamily:font,fontSize:28,color:s.color}}>{s.value}</div></div>
              ))}
            </div>
            {active.length>0&&<div style={{marginBottom:24}}><h2 style={{fontFamily:font,fontSize:20,marginBottom:12}}>Active Projects</h2>{active.map(j=><JobCard key={j.id} job={j}/>)}</div>}
            {upcoming.length>0&&<div><h2 style={{fontFamily:font,fontSize:20,marginBottom:12}}>Upcoming</h2>{upcoming.map(j=><JobCard key={j.id} job={j}/>)}</div>}
            {jobs.length===0&&<div style={{...S.card,textAlign:"center",padding:40}}><div style={{fontSize:40,marginBottom:12}}>üî®</div><div style={{fontFamily:font,fontSize:20,marginBottom:8}}>No projects yet</div><div style={{color:C.muted,marginBottom:20}}>Add your first project to get started.</div><button onClick={()=>setShowNew(true)} style={{...S.btn,width:"auto",padding:"10px 24px"}}>+ New Project</button></div>}
          </div>
        )}
        {!loading&&page==="jobs"&&(
          <div>
            <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:24}}>
              <h1 style={{fontFamily:font,fontSize:28,margin:0}}>All Projects</h1>
              <button onClick={()=>setShowNew(true)} style={{...S.btn,width:"auto",padding:"10px 20px",fontSize:14}}>+ New Project</button>
            </div>
            {jobs.length===0&&<div style={{color:C.muted}}>No projects yet.</div>}
            {jobs.map(j=><JobCard key={j.id} job={j}/>)}
          </div>
        )}
        {!loading&&page==="clients"&&(
          <div>
            <h1 style={{fontFamily:font,fontSize:28,margin:"0 0 24px 0"}}>Clients</h1>
            {clients.length===0&&<div style={{color:C.muted}}>No clients yet. Add a project with a client email to see clients here.</div>}
            {clients.map(c=>(
              <div key={c.email} style={{...S.card,marginBottom:12}}>
                <div style={{fontFamily:font,fontSize:18,marginBottom:4}}>{c.name}</div>
                <div style={{fontSize:13,color:C.gold,marginBottom:8}}>{c.email}</div>
                <div style={{fontSize:13,color:C.muted}}>{c.jobs.length} project{c.jobs.length!==1?"s":""}: {c.jobs.map(j=>j.name||j.title).join(", ")}</div>
              </div>
            ))}
          </div>
        )}
      </div>
      {showNew&&<NewJobModal onClose={()=>setShowNew(false)}/>}
    </div>
  );
}

function App() {
  const [authState, setAuthState] = useState("loading");
  const [user, setUser] = useState(null);
  const [role, setRole] = useState(null);

  useEffect(()=>{
    const unsub = auth.onAuthStateChanged(async fbUser => {
      if (!fbUser) { setUser(null); setRole(null); setAuthState("out"); return; }
      setUser(fbUser);
      if (fbUser.email.toLowerCase()===OWNER_EMAIL.toLowerCase()) {
        setRole("owner");
      } else {
        try {
          const doc = await db.collection("users").doc(fbUser.uid).get();
          if (doc.exists) { setRole(doc.data().role||"client"); }
          else {
            await db.collection("users").doc(fbUser.uid).set({email:fbUser.email.toLowerCase(),role:"client",createdAt:firebase.firestore.FieldValue.serverTimestamp()});
            setRole("client");
          }
        } catch { setRole("client"); }
      }
      setAuthState("in");
    });
    return ()=>unsub();
  },[]);

  async function signOut() { await auth.signOut(); }

  if (authState==="loading") return <LoadingScreen />;
  if (authState==="out") return <AuthScreen />;
  if (role==="owner") return <OwnerDashboard user={user} onSignOut={signOut} />;
  return <ClientPortal user={user} onSignOut={signOut} />;
}

const root = ReactDOM.createRoot(document.getElementById("root"));
root.render(<App />);
